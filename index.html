<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Sig Crowdfunding DAO</title>
    <style>
        /* --- CSS CHUNG --- */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; color: #333; }
        .container { max-width: 1000px; margin: auto; }
        .hidden { display: none !important; }
        
        button { cursor: pointer; font-weight: bold; border: none; padding: 10px 20px; border-radius: 8px; transition: 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        
        .btn-back { background: transparent; color: #555; border: 1px solid #ccc; float: left; margin-bottom: 10px; }

        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; margin-top: 5px; }

        /* --- UI COMPONENTS --- */
        .campaign-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; text-align: left; display: flex; flex-direction: column; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 160px; object-fit: cover; }
        .card-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; float: right; color: white; }
        .badge.open { background: #28a745; } .badge.closed { background: #6c757d; }
        
        .progress-container { background: #e9ecef; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #28a745; width: 0%; transition: 1s; }

        #detailView { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: left; }
        .detail-header { display: flex; gap: 20px; align-items: start; margin-bottom: 30px; flex-wrap: wrap; }
        .detail-img { width: 300px; height: 200px; object-fit: cover; border-radius: 10px; }
        .detail-info { flex: 1; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .stat-val { display: block; font-size: 1.2em; font-weight: bold; color: #007bff; }

        /* B·∫£ng l·ªãch s·ª≠ & Request */
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .tx-in { background: #f0fff4; } 
        .tx-out { background: #fff5f5; }
        .tx-pending { background: #fff3cd; } /* M√†u v√†ng cho Pending */
        .money-in { color: #28a745; font-weight: bold; } 
        .money-out { color: #dc3545; font-weight: bold; }

        /* Admin Panel */
        .admin-panel { background: #fff3cd; padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üèõÔ∏è Multi-Sig DAO Fund</h2>
            <div>
                <span id="walletAddress" style="font-weight:bold; margin-right: 10px;">...</span>
                <button id="connectBtn" class="btn-primary">üîå K·∫øt n·ªëi V√≠</button>
            </div>
        </div>

        <div id="homeView">
            <div id="adminCreateSection" class="admin-panel hidden" style="text-align: left;">
                <h3>‚ú® T·∫°o D·ª± √Ån M·ªõi (D√†nh cho H·ªôi ƒë·ªìng)</h3>
                <input type="text" id="newTitle" placeholder="T√™n d·ª± √°n">
                <input type="text" id="newDesc" placeholder="M√¥ t·∫£ ng·∫Øn">
                <input type="text" id="newImage" placeholder="Link ·∫£nh (URL)">
                <input type="number" id="newTarget" placeholder="M·ª•c ti√™u (ETH)">
                <button onclick="createCampaign()" class="btn-primary" style="margin-top: 10px;">T·∫°o Ngay</button>
            </div>

            <h3 id="loadingText" class="hidden">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</h3>
            <div id="campaignGrid" class="campaign-grid"></div>
        </div>

        <div id="detailView" class="hidden">
            <button onclick="showHome()" class="btn-back">‚¨Ö Quay l·∫°i</button>
            <div style="clear: both;"></div>

            <div class="detail-header">
                <img id="d-img" src="" class="detail-img">
                <div class="detail-info">
                    <h2 id="d-title" style="margin-top: 0;">T√™n d·ª± √°n</h2>
                    <span id="d-status" class="badge">Tr·∫°ng th√°i</span>
                    <p id="d-desc" style="color: #666; margin: 10px 0;">M√¥ t·∫£...</p>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span style="color:#666">ƒê√£ huy ƒë·ªông</span>
                            <span id="d-raised" class="stat-val">0 ETH</span>
                        </div>
                        <div class="stat-box" style="background: #e3f2fd; border-color: #90caf9;">
                            <span style="color:#0d47a1">S·ªë d∆∞ kh·∫£ d·ª•ng</span>
                            <span id="d-balance" class="stat-val" style="color: #0d47a1">0 ETH</span>
                        </div>
                        <div class="stat-box">
                            <span style="color:#666">M·ª•c ti√™u</span>
                            <span id="d-target" class="stat-val">0 ETH</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div id="d-progress" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div id="donateArea" style="background: #e3f2fd; padding: 20px; border-radius: 10px; border: 1px solid #90caf9;">
                <h3>üíñ ·ª¶ng h·ªô d·ª± √°n n√†y</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="d-amount" placeholder="S·ªë ti·ªÅn (ETH)" step="0.001" style="flex: 1;">
                    <input type="text" id="d-message" placeholder="L·ªùi nh·∫Øn g·ª≠i..." style="flex: 2;">
                    <button id="btnDonateDetail" class="btn-primary">G·ª≠i Quy√™n G√≥p üöÄ</button>
                </div>
            </div>

            <div id="adminAreaDetail" class="admin-panel hidden">
                <h3>üîê H·ªôi ƒë·ªìng Qu·∫£n tr·ªã: ƒê·ªÅ xu·∫•t R√∫t ti·ªÅn</h3>
                <p style="font-size: 0.9em; color: #666;">C·∫ßn <strong id="req-votes">...</strong> phi·∫øu thu·∫≠n ƒë·ªÉ th·ª±c thi.</p>
                
                <input type="text" id="w-address" placeholder="1. ƒê·ªãa ch·ªâ nh·∫≠n ti·ªÅn..." style="margin-bottom: 5px;">
                <input type="number" id="w-amount" placeholder="2. S·ªë ti·ªÅn mu·ªën r√∫t (ETH)..." step="0.001" style="margin-bottom: 5px;">
                <input type="text" id="w-reason" placeholder="3. M·ª•c ƒë√≠ch chi ti√™u..." style="margin-bottom: 5px;">
                
                <button id="btnCreateRequest" class="btn-warning" style="width: 100%;">üìù T·∫°o Y√™u C·∫ßu Duy·ªát Chi</button>
                <button id="btnCloseProject" class="btn-secondary" style="margin-top: 10px; width: 100%;">üîÑ ƒê√≥ng/M·ªü D·ª± √Ån</button>
            </div>

            <h3 style="margin-top: 30px;">üìú L·ªãch s·ª≠ & Y√™u c·∫ßu Chi ti√™u</h3>
            <div class="table-wrapper">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Tr·∫°ng th√°i</th>
                            <th>V√≠ nh·∫≠n/g·ª≠i</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>N·ªôi dung / Ti·∫øn ƒë·ªô duy·ªát</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";

        // üëá C·∫¨P NH·∫¨T CONTRACT ADDRESS M·ªöI SAU KHI DEPLOY V√ÄO ƒê√ÇY üëá
        const CONTRACT_ADDRESS = "0xb511c3F963459d0c711C07649A889fcd7BDA4955"; 
        
        // ABI M·ªõi (C·∫≠p nh·∫≠t cho Multi-sig)
        const CONTRACT_ABI = [
            "function campaignCount() public view returns (uint256)",
            "function campaigns(uint256) public view returns (uint256 id, address creator, string title, string description, string image, uint256 target, uint256 raised, uint256 currentBalance, bool isOpen)",
            "function isOwner(address) public view returns (bool)",
            "function requiredApprovals() public view returns (uint256)",
            
            "function createCampaign(string title, string desc, string image, uint256 target) public",
            "function donateToCampaign(uint256 id, string message) public payable",
            
            // C√°c h√†m m·ªõi
            "function createWithdrawRequest(uint256 id, address to, uint256 amount, string reason) public",
            "function approveWithdrawRequest(uint256 campaignId, uint256 withdrawalId) public",
            "function addProofToWithdrawal(uint256 campaignId, uint256 withdrawalIndex, string proof) public",
            "function toggleCampaignStatus(uint256 id) public",

            // View Helpers
            "function getAllDonations() public view returns (tuple(uint256 campaignId, address donor, uint256 amount, string message, uint256 timestamp)[])",
            "function getCampaignWithdrawals(uint256 campaignId) public view returns (tuple(uint256 id, address to, uint256 amount, string reason, string proof, uint256 timestamp, uint256 approvalCount, bool executed)[])",
            "function hasApproved(uint256 campaignId, uint256 withdrawalId, address user) public view returns (bool)"
        ];

        let provider, signer, contract, currentAddr;
        let currentCampaignId = null;
        let requiredVotes = 0;

        // --- K·∫æT N·ªêI V√ç ---
        document.getElementById("connectBtn").onclick = async () => {
            if (!window.ethereum) return alert("C√†i MetaMask ƒëi!");
            try {
                await window.ethereum.request({ method: "eth_requestAccounts" });
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                currentAddr = await signer.getAddress();
                
                document.getElementById("walletAddress").innerText = currentAddr.substring(0,6) + "...";
                document.getElementById("connectBtn").classList.add("hidden");
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                checkAdminGlobal();
                loadCampaignList();
            } catch(e) { console.error(e); }
        };

        window.showHome = () => {
            document.getElementById("homeView").classList.remove("hidden");
            document.getElementById("detailView").classList.add("hidden");
            loadCampaignList(); 
        };

        window.openDetail = async (id) => {
            currentCampaignId = id; 
            document.getElementById("homeView").classList.add("hidden");
            document.getElementById("detailView").classList.remove("hidden");
            loadDetailData(id);
        };

        async function loadCampaignList() {
            const grid = document.getElementById("campaignGrid");
            grid.innerHTML = "";
            document.getElementById("loadingText").classList.remove("hidden");

            try {
                const count = Number(await contract.campaignCount());
                if(count === 0) grid.innerHTML = "<p>Ch∆∞a c√≥ d·ª± √°n n√†o.</p>";

                for (let i = 0; i < count; i++) {
                    const c = await contract.campaigns(i);
                    const raised = ethers.formatEther(c[6]);
                    const target = ethers.formatEther(c[5]);
                    const percent = (Number(raised) / Number(target)) * 100;
                    const isOpen = c[8]; 

                    const card = document.createElement("div");
                    card.className = "card";
                    card.onclick = () => window.openDetail(i);
                    card.innerHTML = `
                        <img src="${c[4]}" class="card-img" onerror="this.src='https://via.placeholder.com/300'">
                        <div class="card-body">
                            <h3 style="margin:0 0 10px;">${c[2]} <span class="badge ${isOpen ? 'open' : 'closed'}">${isOpen ? 'M·ªü' : 'ƒê√≥ng'}</span></h3>
                            <p style="color:#666; font-size:0.9em; flex:1">${c[3].substring(0, 100)}...</p>
                            <div style="margin-top:10px;"><strong>${raised}</strong> / ${target} ETH</div>
                            <div class="progress-container"><div class="progress-bar" style="width: ${Math.min(percent, 100)}%"></div></div>
                            <button class="btn-primary" style="width:100%; margin-top:10px;">Xem Chi Ti·∫øt</button>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            } catch (e) { console.error(e); }
            document.getElementById("loadingText").classList.add("hidden");
        }

        async function loadDetailData(id) {
            try {
                const c = await contract.campaigns(id);
                document.getElementById("d-img").src = c[4];
                document.getElementById("d-title").innerText = c[2];
                document.getElementById("d-desc").innerText = c[3];
                
                const raised = ethers.formatEther(c[6]);
                const balance = ethers.formatEther(c[7]); 
                const target = ethers.formatEther(c[5]);
                const percent = (Number(raised) / Number(target)) * 100;
                
                document.getElementById("d-raised").innerText = raised + " ETH";
                document.getElementById("d-balance").innerText = balance + " ETH";
                document.getElementById("d-target").innerText = target + " ETH";
                document.getElementById("d-progress").style.width = Math.min(percent, 100) + "%";
                
                const isOpen = c[8]; 
                const badge = document.getElementById("d-status");
                if (isOpen) {
                    badge.innerText = "ƒêang m·ªü"; badge.className = "badge open";
                    document.getElementById("donateArea").classList.remove("hidden");
                } else {
                    badge.innerText = "ƒê√£ ƒë√≥ng"; badge.className = "badge closed";
                    document.getElementById("donateArea").classList.add("hidden");
                }

                // Check Admin
                const isOwner = await contract.isOwner(currentAddr);
                if (isOwner) {
                    document.getElementById("adminAreaDetail").classList.remove("hidden");
                    requiredVotes = await contract.requiredApprovals();
                    document.getElementById("req-votes").innerText = requiredVotes;
                } else {
                    document.getElementById("adminAreaDetail").classList.add("hidden");
                }

                renderHistoryTable(id, isOwner);

            } catch (e) { console.error("L·ªói detail:", e); }
        }

        async function renderHistoryTable(campaignId, isAdmin) {
            const tbody = document.getElementById("historyBody");
            tbody.innerHTML = "<tr><td colspan='5'>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>";

            try {
                // 1. Donations
                const allDonations = await contract.getAllDonations();
                const myDonations = allDonations
                    .filter(d => Number(d.campaignId) === campaignId)
                    .map(d => ({
                        type: 'IN',
                        who: d.donor,
                        amount: d.amount,
                        msg: d.message,
                        time: d.timestamp,
                        status: 'Th√†nh c√¥ng'
                    }));

                // 2. Withdraw Requests
                const withdrawals = await contract.getCampaignWithdrawals(campaignId);
                const myWithdraws = await Promise.all(withdrawals.map(async (w, idx) => {
                    // Check xem m√¨nh ƒë√£ vote ch∆∞a
                    const voted = isAdmin ? await contract.hasApproved(campaignId, idx, currentAddr) : false;
                    
                    return {
                        type: 'OUT',
                        who: w.to,
                        amount: w.amount,
                        msg: w.reason,
                        proof: w.proof,
                        time: w.timestamp,
                        index: idx,
                        executed: w.executed,
                        approvals: w.approvalCount,
                        voted: voted
                    };
                }));

                const combined = [...myDonations, ...myWithdraws].sort((a,b) => Number(b.time) - Number(a.time));

                tbody.innerHTML = "";
                if (combined.length === 0) tbody.innerHTML = "<tr><td colspan='5'>Ch∆∞a c√≥ giao d·ªãch n√†o.</td></tr>";

                combined.forEach(t => {
                    const isIn = t.type === 'IN';
                    let statusBadge = "";
                    let actionHtml = "";

                    if (isIn) {
                        statusBadge = `<span style="color:green">‚úÖ ƒê√£ nh·∫≠n</span>`;
                    } else {
                        // Logic hi·ªÉn th·ªã cho R√∫t ti·ªÅn
                        if (t.executed) {
                            statusBadge = `<span style="color:blue">üöÄ ƒê√£ chuy·ªÉn</span>`;
                            if (t.proof) actionHtml = `<a href="${t.proof}" target="_blank">Xem h√≥a ƒë∆°n</a>`;
                            else if (isAdmin) actionHtml = `<button onclick="window.uploadProof(${t.index})" style="font-size:0.8em">Up h√≥a ƒë∆°n</button>`;
                        } else {
                            statusBadge = `<span style="color:#e67e22">‚è≥ Ch·ªù duy·ªát (${t.approvals}/${requiredVotes})</span>`;
                            if (isAdmin) {
                                if (t.voted) actionHtml = `<span style="color:green; font-size:0.8em">ƒê√£ duy·ªát</span>`;
                                else actionHtml = `<button onclick="window.approveRequest(${t.index})" class="btn-success" style="padding:4px 8px; font-size:0.8em">‚úÖ Duy·ªát chi</button>`;
                            }
                        }
                    }

                    tbody.innerHTML += `
                        <tr class="${isIn ? 'tx-in' : (t.executed ? 'tx-out' : 'tx-pending')}">
                            <td>${statusBadge}</td>
                            <td>${t.who.substring(0,6)}...</td>
                            <td class="${isIn ? 'money-in' : 'money-out'}">${isIn ? '+' : '-'} ${ethers.formatEther(t.amount)}</td>
                            <td style="text-align: left;">
                                <strong>${t.msg}</strong>
                            </td>
                            <td>${actionHtml}</td>
                        </tr>
                    `;
                });
            } catch(e) { console.error(e); }
        }

        // --- GLOBAL ACTIONS ---
        
        window.createCampaign = async () => {
            const t = document.getElementById("newTitle").value;
            const d = document.getElementById("newDesc").value;
            const i = document.getElementById("newImage").value;
            const v = document.getElementById("newTarget").value;
            if(!t || !v) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");
            
            try {
                const tx = await contract.createCampaign(t, d, i, ethers.parseEther(v));
                await tx.wait();
                alert("ƒê√£ t·∫°o d·ª± √°n!");
                loadCampaignList();
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        document.getElementById("btnDonateDetail").onclick = async () => {
            const amt = document.getElementById("d-amount").value;
            const msg = document.getElementById("d-message").value;
            if(!amt) return alert("Nh·∫≠p s·ªë ti·ªÅn!");

            try {
                const tx = await contract.donateToCampaign(currentCampaignId, msg, { value: ethers.parseEther(amt) });
                await tx.wait();
                alert("Quy√™n g√≥p th√†nh c√¥ng!");
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // T·∫°o Y√™u c·∫ßu R√∫t ti·ªÅn (B∆∞·ªõc 1)
        document.getElementById("btnCreateRequest").onclick = async () => {
            const to = document.getElementById("w-address").value;
            const amt = document.getElementById("w-amount").value;
            const reason = document.getElementById("w-reason").value;

            if(!to || !amt || !reason) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin!");

            try {
                const tx = await contract.createWithdrawRequest(currentCampaignId, to, ethers.parseEther(amt), reason);
                alert("‚è≥ ƒêang t·∫°o y√™u c·∫ßu r√∫t ti·ªÅn...");
                await tx.wait();
                alert("‚úÖ ƒê√£ t·∫°o y√™u c·∫ßu! Ch·ªù c√°c th√†nh vi√™n kh√°c duy·ªát.");
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        // Duy·ªát Y√™u c·∫ßu (B∆∞·ªõc 2)
        window.approveRequest = async (withdrawalId) => {
            try {
                const tx = await contract.approveWithdrawRequest(currentCampaignId, withdrawalId);
                alert("‚è≥ ƒêang g·ª≠i phi·∫øu thu·∫≠n...");
                await tx.wait();
                alert("‚úÖ ƒê√£ duy·ªát th√†nh c√¥ng!");
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        window.uploadProof = async (withdrawalIndex) => {
            const proofLink = prompt("Link minh ch·ª©ng:");
            if (!proofLink) return;
            try {
                const tx = await contract.addProofToWithdrawal(currentCampaignId, withdrawalIndex, proofLink);
                await tx.wait();
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        document.getElementById("btnCloseProject").onclick = async () => {
             try {
                const tx = await contract.toggleCampaignStatus(currentCampaignId);
                await tx.wait();
                loadDetailData(currentCampaignId);
            } catch(e) { alert("L·ªói: " + e.message); }
        };

        async function checkAdminGlobal() {
            try {
                const isOwner = await contract.isOwner(currentAddr);
                if (isOwner) {
                    document.getElementById("adminCreateSection").classList.remove("hidden");
                }
            } catch(e) {}
        }
    </script>
</body>
</html>